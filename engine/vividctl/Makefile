.PHONY: build clean install test example help

# é»˜è®¤ç›®æ ‡
all: build

# æ„å»ºå·¥å…·
build:
	@echo "ğŸ”¨ æ„å»º vividctl..."
	@go build -o vividctl
	@echo "âœ… æ„å»ºå®Œæˆ: vividctl"

# Windows æ„å»º
build-windows:
	@echo "ğŸ”¨ æ„å»º vividctl (Windows)..."
	@go build -o vividctl.exe
	@echo "âœ… æ„å»ºå®Œæˆ: vividctl.exe"

# æ¸…ç†ç”Ÿæˆçš„æ–‡ä»¶
clean:
	@echo "ğŸ§¹ æ¸…ç†æ–‡ä»¶..."
	@rm -f vividctl vividctl.exe
	@rm -f test_*.go example_*.go
	@echo "âœ… æ¸…ç†å®Œæˆ"

# å®‰è£…åˆ°ç³»ç»Ÿè·¯å¾„
install: build
	@echo "ğŸ“¦ å®‰è£…å·¥å…·åˆ°ç³»ç»Ÿè·¯å¾„..."
	@cp vividctl $(GOPATH)/bin/vividctl
	@echo "âœ… å®‰è£…å®Œæˆï¼Œå¯ä»¥åœ¨ä»»æ„ä½ç½®ä½¿ç”¨ 'vividctl' å‘½ä»¤"

# è¿è¡Œæµ‹è¯•
test: build
	@echo "ğŸ§ª è¿è¡Œæµ‹è¯•..."
	@go test ./...

# è¿è¡Œç¤ºä¾‹
example: build
	@echo "ğŸš€ è¿è¡Œé…ç½®ç”Ÿæˆç¤ºä¾‹..."
	@echo "ç”Ÿæˆæ•°æ®åº“é…ç½®ç¤ºä¾‹..."
	@./vividctl config init -p example -n Database -o example_database_config.go
	@./vividctl config add -f example_database_config.go -n Host -t string -c "æ•°æ®åº“ä¸»æœºåœ°å€" -d '"localhost"'
	@./vividctl config add -f example_database_config.go -n Port -t int -c "æ•°æ®åº“ç«¯å£" -d "5432"
	@./vividctl config add -f example_database_config.go -n Username -t string -c "ç”¨æˆ·å" -d '"postgres"'
	@./vividctl config add -f example_database_config.go -n MaxConnections -t int -c "æœ€å¤§è¿æ¥æ•°" -d "100"
	@./vividctl config add -f example_database_config.go -n Timeout -t time.Duration -c "è¿æ¥è¶…æ—¶æ—¶é—´" -d "time.Second*30"
	@echo ""
	@echo "ç”ŸæˆHTTPæœåŠ¡å™¨é…ç½®ç¤ºä¾‹..."
	@./vividctl config init -p example -n HTTPServer -o example_http_config.go
	@./vividctl config add -f example_http_config.go -n Addr -t string -c "æœåŠ¡å™¨ç›‘å¬åœ°å€" -d '":8080"'
	@./vividctl config add -f example_http_config.go -n ReadTimeout -t time.Duration -c "è¯»å–è¶…æ—¶æ—¶é—´" -d "time.Second*30"
	@./vividctl config add -f example_http_config.go -n EnableTLS -t bool -c "æ˜¯å¦å¯ç”¨TLS" -d "false"
	@echo ""
	@echo "âœ… ç¤ºä¾‹å®Œæˆï¼æŸ¥çœ‹ç”Ÿæˆçš„æ–‡ä»¶ï¼š"
	@ls -la example_*.go

# æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯
version: build
	@echo "vividctl version: $(shell git describe --tags --always --dirty 2>/dev/null || echo 'dev')"
	@echo "Go version: $(shell go version)"

# æ ¼å¼åŒ–ä»£ç 
fmt:
	@echo "ğŸ¨ æ ¼å¼åŒ–ä»£ç ..."
	@go fmt ./...
	@echo "âœ… ä»£ç æ ¼å¼åŒ–å®Œæˆ"

# é™æ€æ£€æŸ¥
lint:
	@echo "ğŸ” è¿è¡Œé™æ€æ£€æŸ¥..."
	@go vet ./...
	@echo "âœ… é™æ€æ£€æŸ¥å®Œæˆ"

# ä¾èµ–ç®¡ç†
deps:
	@echo "ğŸ“¦ æ›´æ–°ä¾èµ–..."
	@go mod tidy
	@go mod download
	@echo "âœ… ä¾èµ–æ›´æ–°å®Œæˆ"

# å¿«é€Ÿæµ‹è¯•é…ç½®å‘½ä»¤
test-config: build
	@echo "ğŸ§ª å¿«é€Ÿæµ‹è¯•é…ç½®å‘½ä»¤..."
	@./vividctl config init -p test -n TestConfig -o test_config.go
	@./vividctl config add -f test_config.go -n TestField -t string -c "æµ‹è¯•å­—æ®µ" -d '"test"'
	@echo "âœ… æµ‹è¯•å®Œæˆï¼ŒæŸ¥çœ‹ç”Ÿæˆçš„æ–‡ä»¶: test_config.go"

# å¸®åŠ©ä¿¡æ¯
help:
	@echo "VividCTL æ„å»ºå·¥å…·"
	@echo ""
	@echo "å¯ç”¨å‘½ä»¤:"
	@echo "  build         æ„å»º vividctl"
	@echo "  build-windows æ„å»º Windows ç‰ˆæœ¬"
	@echo "  clean         æ¸…ç†ç”Ÿæˆçš„æ–‡ä»¶"
	@echo "  install       å®‰è£…åˆ°ç³»ç»Ÿè·¯å¾„"
	@echo "  test          è¿è¡Œæµ‹è¯•"
	@echo "  example       è¿è¡Œç¤ºä¾‹"
	@echo "  test-config   å¿«é€Ÿæµ‹è¯•é…ç½®å‘½ä»¤"
	@echo "  version       æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯"
	@echo "  fmt           æ ¼å¼åŒ–ä»£ç "
	@echo "  lint          é™æ€æ£€æŸ¥"
	@echo "  deps          æ›´æ–°ä¾èµ–"
	@echo "  help          æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"
	@echo ""
	@echo "ä½¿ç”¨ç¤ºä¾‹:"
	@echo "  make build                    # æ„å»ºå·¥å…·"
	@echo "  make example                  # è¿è¡Œç¤ºä¾‹"
	@echo "  make test-config              # å¿«é€Ÿæµ‹è¯•"
	@echo "  ./vividctl config init        # åˆå§‹åŒ–é…ç½®"
	@echo "  ./vividctl config add         # æ·»åŠ å­—æ®µ"
	@echo "  ./vividctl config del         # åˆ é™¤å­—æ®µ" 
---
description: 
globs: 
alwaysApply: true
---
# Engine V1 å¼€å‘è§„èŒƒ

## 1. ä»£ç ç»„ç»‡è§„èŒƒ

### 1.1 åŒ…ç»“æ„è§„èŒƒ
```
engine/v1/
â”œâ”€â”€ *.go              // å…¬å…± API æ¥å£
â”œâ”€â”€ internal/         // å†…éƒ¨å®ç°ï¼Œå¤–éƒ¨ä¸å¯è®¿é—®
â”‚   â””â”€â”€ processor/    // å…·ä½“åŠŸèƒ½æ¨¡å—
â””â”€â”€ processor/        // å…¬å…±æ¥å£å®šä¹‰
```

**å¼ºåˆ¶è§„åˆ™**ï¼š
- å…¬å…± API å¿…é¡»åœ¨åŒ…æ ¹ç›®å½•å®šä¹‰
- å…·ä½“å®ç°å¿…é¡»æ”¾åœ¨ `internal` åŒ…ä¸­
- æ¯ä¸ªåŠŸèƒ½æ¨¡å—ç‹¬ç«‹å­åŒ…
- ä½¿ç”¨ `internal` åŒ…éšè—å®ç°ç»†èŠ‚

### 1.2 æ–‡ä»¶å‘½åè§„èŒƒ
```
unit.go              // æ ¸å¿ƒæ¥å£å®šä¹‰
registry.go          // æ³¨å†Œè¡¨å®ç°
*_config.go          // é…ç½®ç›¸å…³
*_test.go           // å•å…ƒæµ‹è¯•
rpc_*.go            // RPC åŠŸèƒ½æ¨¡å—
errors.go           // é”™è¯¯å®šä¹‰
README.md           // æ¨¡å—æ–‡æ¡£
```

**å¼ºåˆ¶è§„åˆ™**ï¼š
- æ¥å£å®šä¹‰æ–‡ä»¶ä½¿ç”¨å•æ•°åè¯
- é…ç½®æ–‡ä»¶å¿…é¡»ä»¥ `_config.go` ç»“å°¾
- RPC ç›¸å…³æ–‡ä»¶å¿…é¡»ä»¥ `rpc_` å¼€å¤´
- é”™è¯¯å®šä¹‰ç»Ÿä¸€æ”¾åœ¨ `errors.go` ä¸­

## 2. æ¥å£è®¾è®¡è§„èŒƒ

### 2.1 æ¥å£å®šä¹‰è§„èŒƒ
```go
// æ­£ç¡®ï¼šèŒè´£å•ä¸€çš„åŸºç¡€æ¥å£
type Unit interface {
    Handle(sender UnitIdentifier, message any)
}

// æ­£ç¡®ï¼šåŠŸèƒ½æ‰©å±•æ¥å£
type UnitInitializer interface {
    Unit
    Init()
}

// é”™è¯¯ï¼šæ¥å£è¿‡äºåºå¤§
type BadUnit interface {
    Handle(sender UnitIdentifier, message any)
    Init()
    Close()
    GetStatus() string
    Configure(config Config)
}
```

**å¼ºåˆ¶è§„åˆ™**ï¼š
- æ¥å£å¿…é¡»èŒè´£å•ä¸€ï¼Œéµå¾ªå•ä¸€èŒè´£åŸåˆ™
- æ‰©å±•åŠŸèƒ½é€šè¿‡æ¥å£ç»„åˆå®ç°ï¼Œä¸ä¿®æ”¹åŸºç¡€æ¥å£
- æ¥å£æ–¹æ³•æ•°é‡ä¸è¶…è¿‡ 3 ä¸ªï¼ˆç‰¹æ®Šæƒ…å†µé™¤å¤–ï¼‰
- ä½¿ç”¨ç±»å‹æ–­è¨€æ£€æŸ¥æ¥å£å®ç°ï¼š`as*()`å‡½æ•°æ¨¡å¼

### 2.2 æ¥å£å‘½åè§„èŒƒ
```go
// æ­£ç¡®ï¼šæè¿°èƒ½åŠ›çš„æ¥å£å
type UnitInitializer interface { Init() }
type UnitCloser interface { Close() }

// æ­£ç¡®ï¼šé€šç”¨æ¥å£ä½¿ç”¨ -er åç¼€
type Handler interface { Handle() }
type Provider interface { Provide() }

// é”™è¯¯ï¼šè¿‡äºæŠ½è±¡çš„å‘½å
type Manager interface {}
type Helper interface {}
```

**å¼ºåˆ¶è§„åˆ™**ï¼š
- æ¥å£åå¿…é¡»æ˜ç¡®è¡¨è¾¾èƒ½åŠ›æˆ–èŒè´£
- å•æ–¹æ³•æ¥å£ä½¿ç”¨ `-er` åç¼€
- é¿å… `Manager`ã€`Helper` ç­‰æ¨¡ç³Šå‘½å
- åŠŸèƒ½æ‰©å±•æ¥å£ä½¿ç”¨ `{åŸºç¡€æ¥å£å}{åŠŸèƒ½å}` æ ¼å¼

## 3. é…ç½®ç®¡ç†è§„èŒƒ

### 3.1 é…ç½®å™¨æ¨¡å¼è§„èŒƒ
```go
// å¼ºåˆ¶ï¼šåŒæ—¶æä¾›é“¾å¼å’Œå‡½æ•°å¼é…ç½®
type Configuration struct {
    Logger log.Logger
    // ...
}

// é“¾å¼é…ç½®æ–¹æ³•
func (c *Configuration) WithLogger(logger log.Logger) *Configuration {
    c.Logger = logger
    return c
}

// å‡½æ•°å¼é…ç½®é€‰é¡¹
func WithLogger(logger log.Logger) Option {
    return func(c *Configuration) {
        c.WithLogger(logger)
    }
}
```

**å¼ºåˆ¶è§„åˆ™**ï¼š
- å¿…é¡»åŒæ—¶æä¾›é“¾å¼å’Œå‡½æ•°å¼ä¸¤ç§é…ç½®æ–¹å¼
- é…ç½®æ–¹æ³•å¿…é¡»è¿”å›é…ç½®å¯¹è±¡æœ¬èº«ï¼Œæ”¯æŒé“¾å¼è°ƒç”¨
- ä½¿ç”¨ `With` å‰ç¼€å‘½åé…ç½®æ–¹æ³•
- é…ç½®é€‰é¡¹ä½¿ç”¨ `Option` ç±»å‹åˆ«å

### 3.2 æ„é€ å‡½æ•°è§„èŒƒ
```go
// å¼ºåˆ¶ï¼šæä¾›å¤šç§æ„é€ æ–¹å¼
func NewComponentWithOptions(options ...Option) Component
func NewComponentWithConfigurators(configurators ...Configurator) Component  
func NewComponentFromConfig(config *Configuration) Component

// ç§æœ‰æ„é€ å‡½æ•°ç»Ÿä¸€å¤„ç†
func newComponent(config Configuration) *component {
    // è®¾ç½®é»˜è®¤å€¼
    if config.Logger == nil {
        config.Logger = log.GetDefault()
    }
    return &component{config: config}
}
```

**å¼ºåˆ¶è§„åˆ™**ï¼š
- å¿…é¡»æä¾›é€‰é¡¹æ¨¡å¼ã€é…ç½®å™¨æ¨¡å¼ã€é…ç½®å¯¹è±¡ä¸‰ç§æ„é€ æ–¹å¼
- ä½¿ç”¨ç§æœ‰æ„é€ å‡½æ•° `new*()` ç»Ÿä¸€å¤„ç†é…ç½®
- åœ¨æ„é€ å‡½æ•°ä¸­è®¾ç½®é»˜è®¤å€¼å’ŒéªŒè¯é…ç½®
- å…¬å…±æ„é€ å‡½æ•°åªåšå‚æ•°è½¬æ¢ï¼Œä¸å¤„ç†ä¸šåŠ¡é€»è¾‘

## 4. å¹¶å‘å®‰å…¨è§„èŒƒ

### 4.1 çŠ¶æ€ç®¡ç†è§„èŒƒ
```go
// å¼ºåˆ¶ï¼šçŠ¶æ€å¸¸é‡å®šä¹‰
const (
    stateIdle uint32 = iota
    stateRunning
    stateShutdown
)

type component struct {
    state   atomic.Uint32
    counter atomic.Int64
    // ...
}

// å¼ºåˆ¶ï¼šä½¿ç”¨ CAS æ“ä½œè¿›è¡ŒçŠ¶æ€åˆ‡æ¢
func (c *component) start() bool {
    return c.state.CompareAndSwap(stateIdle, stateRunning)
}
```

**å¼ºåˆ¶è§„åˆ™**ï¼š
- çŠ¶æ€å€¼å¿…é¡»ä½¿ç”¨å¸¸é‡å®šä¹‰
- çŠ¶æ€å­—æ®µå¿…é¡»ä½¿ç”¨ `atomic` åŒ…ç±»å‹
- çŠ¶æ€åˆ‡æ¢å¿…é¡»ä½¿ç”¨ `CompareAndSwap` æ“ä½œ
- é¿å…ç›´æ¥ä½¿ç”¨ `Store/Load`ï¼Œé™¤éæ˜¯åªè¯»æ“ä½œ

### 4.2 å¹¶å‘æ•°æ®ç»“æ„è§„èŒƒ
```go
// å¼ºåˆ¶ï¼šä½¿ç”¨æ— é”æ•°æ®ç»“æ„
type registry struct {
    units    *xsync.MapOf[string, Unit]  // å¹¶å‘å®‰å…¨çš„æ˜ å°„
    rpcLock  *xsync.MapOf[string, *sync.Mutex]  // ç»†ç²’åº¦é”
    shutdown atomic.Bool  // åŸå­å¸ƒå°”å€¼
}

// ç¦æ­¢ï¼šä½¿ç”¨å…¨å±€é”
type badRegistry struct {
    mu    sync.RWMutex  // é¿å…ä½¿ç”¨å…¨å±€é”
    units map[string]Unit
}
```

**å¼ºåˆ¶è§„åˆ™**ï¼š
- ä¼˜å…ˆä½¿ç”¨ `xsync.MapOf` æ›¿ä»£ `sync.Map`
- é¿å…ä½¿ç”¨å…¨å±€è¯»å†™é”ï¼Œä½¿ç”¨ç»†ç²’åº¦é”
- è®¡æ•°å™¨ä½¿ç”¨ `atomic.Int64` ç­‰åŸå­ç±»å‹
- å¸ƒå°”æ ‡å¿—ä½¿ç”¨ `atomic.Bool`

## 5. é”™è¯¯å¤„ç†è§„èŒƒ

### 5.1 é”™è¯¯å®šä¹‰è§„èŒƒ
```go
// å¼ºåˆ¶ï¼šåŒ…çº§åˆ«é”™è¯¯å˜é‡
var (
    ErrRegistryShutdown      = errors.New("registry is shutdown")
    ErrUnitNotFound         = errors.New("unit not found") 
    ErrUnitIdentifierInvalid = errors.New("unit identifier is invalid")
)

// å¼ºåˆ¶ï¼šé”™è¯¯åç§°è§„èŒƒ
var (
    Err{ç»„ä»¶å}{é”™è¯¯ç±»å‹} = errors.New("æè¿°ä¿¡æ¯")
)
```

**å¼ºåˆ¶è§„åˆ™**ï¼š
- åŒ…çº§åˆ«é”™è¯¯å¿…é¡»ä»¥ `Err` å¼€å¤´
- é”™è¯¯åæ ¼å¼ï¼š`Err{ç»„ä»¶å}{é”™è¯¯ç±»å‹}`
- é”™è¯¯ä¿¡æ¯ä½¿ç”¨å°å†™ï¼Œç®€æ´æ˜ç¡®
- ç»Ÿä¸€åœ¨ `errors.go` æ–‡ä»¶ä¸­å®šä¹‰

### 5.2 é”™è¯¯å¤„ç†è§„èŒƒ
```go
// å¼ºåˆ¶ï¼šå±‚çº§é”™è¯¯å¤„ç†
func (r *registry) GetUnit(id CacheUnitIdentifier) (Unit, error) {
    if r.IsShutdown() {
        return nil, ErrRegistryShutdown
    }
    
    // å°è¯•è·å–å•å…ƒ
    if unit, err := r.getUnitFromCache(id); err == nil {
        return unit, nil
    }
    
    // å›é€€åˆ°å®ˆæŠ¤å•å…ƒ
    if daemon, exists := r.getDaemon(); exists {
        return daemon, nil
    }
    
    return nil, ErrUnitNotFound
}
```

**å¼ºåˆ¶è§„åˆ™**ï¼š
- ä¼˜å…ˆè¿”å›å…·ä½“é”™è¯¯ï¼Œè€Œéé€šç”¨é”™è¯¯
- å®ç°å›é€€æœºåˆ¶ï¼Œé¿å…ç›´æ¥å¤±è´¥
- é”™è¯¯ä¿¡æ¯è¦åŒ…å«è¶³å¤Ÿçš„ä¸Šä¸‹æ–‡
- ä½¿ç”¨ `errors.Is()` è¿›è¡Œé”™è¯¯ç±»å‹åˆ¤æ–­

## 6. ç”Ÿå‘½å‘¨æœŸç®¡ç†è§„èŒƒ

### 6.1 åˆå§‹åŒ–è§„èŒƒ
```go
// å¼ºåˆ¶ï¼šè‡ªåŠ¨åˆå§‹åŒ–æ£€æŸ¥
func (r *registry) RegisterUnit(id UnitIdentifier, unit Unit) error {
    // å‚æ•°éªŒè¯
    if id == nil {
        return ErrUnitIdentifierInvalid
    }
    if unit == nil {
        return ErrUnitInvalid
    }
    
    // è‡ªåŠ¨åˆå§‹åŒ–
    if initializer := asUnitInitializer(unit); initializer != nil {
        initializer.Init()
    }
    
    // å­˜å‚¨å•å…ƒ
    r.units.Store(id.GetPath(), unit)
    return nil
}

// å¼ºåˆ¶ï¼šç±»å‹æ–­è¨€è¾…åŠ©å‡½æ•°
func asUnitInitializer(unit Unit) UnitInitializer {
    if initializer, ok := unit.(UnitInitializer); ok {
        return initializer
    }
    return nil
}
```

**å¼ºåˆ¶è§„åˆ™**ï¼š
- æ³¨å†Œæ—¶è‡ªåŠ¨æ£€æŸ¥å¹¶è°ƒç”¨åˆå§‹åŒ–æ¥å£
- ä½¿ç”¨ `as*()` å‡½æ•°è¿›è¡Œç±»å‹æ–­è¨€
- åˆå§‹åŒ–å¤±è´¥ä¸å½±å“æ³¨å†Œæµç¨‹
- å‚æ•°éªŒè¯åœ¨ä¸šåŠ¡é€»è¾‘ä¹‹å‰

### 6.2 å…³é—­è§„èŒƒ
```go
// å¼ºåˆ¶ï¼šä¼˜é›…å…³é—­æ¨¡å¼
func (r *registry) Shutdown(operator UnitIdentifier) error {
    // é˜²é‡å¤å…³é—­
    if !r.shutdown.CompareAndSwap(false, true) {
        return ErrRegistryShutdown
    }
    
    // å…³é—­æ‰€æœ‰å•å…ƒ
    r.units.Range(func(path string, unit Unit) bool {
        if closer := asUnitCloser(unit); closer != nil {
            closer.Close(operator)
        }
        return true
    })
    
    // å…³é—­ RPC æœåŠ¡å™¨
    if r.rpcServer != nil {
        return r.rpcServer.Shutdown()
    }
    
    return nil
}
```

**å¼ºåˆ¶è§„åˆ™**ï¼š
- ä½¿ç”¨åŸå­æ“ä½œé˜²æ­¢é‡å¤å…³é—­
- è‡ªåŠ¨æ£€æŸ¥å¹¶è°ƒç”¨å…³é—­æ¥å£
- æŒ‰ä¾èµ–é¡ºåºå…³é—­ç»„ä»¶
- æä¾›æ“ä½œè€…ä¿¡æ¯ç”¨äºå®¡è®¡

## 7. ç½‘ç»œé€šä¿¡è§„èŒƒ

### 7.1 æ¥å£æŠ½è±¡è§„èŒƒ
```go
// å¼ºåˆ¶ï¼šç½‘ç»œå±‚æŠ½è±¡
type RPCConn interface {
    Send(data []byte) error
    Close() error
}

type RPCConnProvider interface {
    GetConn(address string) (RPCConn, error)
}

// å¼ºåˆ¶ï¼šåºåˆ—åŒ–æŠ½è±¡
type Serializer interface {
    Serialize(message any) (typ string, data []byte, err error)
    Deserialize(typ string, data []byte) (message any, err error)
}
```

**å¼ºåˆ¶è§„åˆ™**ï¼š
- ç½‘ç»œä¼ è¾“å¿…é¡»å®Œå…¨æŠ½è±¡åŒ–
- åºåˆ—åŒ–åè®®å¿…é¡»å¯æ’æ‹”
- è¿æ¥ç®¡ç†ä¸ä¸šåŠ¡é€»è¾‘åˆ†ç¦»
- æ”¯æŒå¤šç§ä¼ è¾“åè®®æ‰©å±•

### 7.2 æ‰¹å¤„ç†è§„èŒƒ
```go
// å¼ºåˆ¶ï¼šå¼‚æ­¥æ‰¹å¤„ç†æ¨¡å¼
func (r *rpcUnit) Handle(sender UnitIdentifier, message any) {
    // åºåˆ—åŒ–æ¶ˆæ¯
    typ, data, err := r.config.Serializer.Serialize(message)
    if err != nil {
        r.Logger().Error("serialize", log.Err(err))
        return
    }
    
    // å…¥é˜Ÿåˆ—
    r.queue.Push(&rpcUnitMessage{...})
    
    // åŸå­è®¡æ•°
    atomic.AddInt32(&r.num, 1)
    
    // å¯åŠ¨æ‰¹å¤„ç†
    if atomic.CompareAndSwapUint32(&r.status, rpcUnitIdle, rpcUnitRunning) {
        go r.flush()
    }
}
```

**å¼ºåˆ¶è§„åˆ™**ï¼š
- æ¶ˆæ¯å¤„ç†å¿…é¡»å¼‚æ­¥åŒ–
- ä½¿ç”¨æ— é”é˜Ÿåˆ—ç¼“å­˜æ¶ˆæ¯
- æ‰¹é‡å‘é€æé«˜ç½‘ç»œæ•ˆç‡
- å¤±è´¥é‡è¯•ä½¿ç”¨æŒ‡æ•°é€€é¿ç®—æ³•

## 8. æµ‹è¯•ç¼–å†™è§„èŒƒ

### 8.1 æµ‹è¯•æ–‡ä»¶è§„èŒƒ
```go
// æ–‡ä»¶åï¼š*_test.go
func TestRegistryRegisterUnit(t *testing.T) {
    // Arrange
    registry := NewRegistryWithOptions(
        WithLogger(log.GetDefault()),
    )
    unit := &mockUnit{}
    id := NewUnitIdentifier("localhost", "/test")
    
    // Act
    err := registry.RegisterUnit(id, unit)
    
    // Assert
    assert.NoError(t, err)
    assert.Equal(t, 1, registry.UnitCount())
}
```

**å¼ºåˆ¶è§„åˆ™**ï¼š
- æµ‹è¯•æ–¹æ³•åæ ¼å¼ï¼š`Test{ç»„ä»¶å}{æ–¹æ³•å}`
- ä½¿ç”¨ AAA æ¨¡å¼ï¼šArrangeã€Actã€Assert
- æ¯ä¸ªæµ‹è¯•åªéªŒè¯ä¸€ä¸ªåœºæ™¯
- ä½¿ç”¨ mock å¯¹è±¡éš”ç¦»ä¾èµ–

### 8.2 ç¤ºä¾‹ä»£ç è§„èŒƒ
```go
func ExampleRegistry_RegisterUnit() {
    registry := NewRegistryWithOptions(
        WithLogger(log.GetDefault()),
    )
    
    unit := &MyUnit{}
    id := NewUnitIdentifier("localhost", "/service")
    
    err := registry.RegisterUnit(id, unit)
    if err != nil {
        log.Fatal(err)
    }
    
    fmt.Printf("Unit count: %d\n", registry.UnitCount())
    // Output: Unit count: 1
}
```

**å¼ºåˆ¶è§„åˆ™**ï¼š
- ç¤ºä¾‹å‡½æ•°åæ ¼å¼ï¼š`Example{ç±»å‹}_{æ–¹æ³•}`
- å¿…é¡»åŒ…å«å®Œæ•´çš„ä½¿ç”¨æµç¨‹
- å¿…é¡»åŒ…å« `// Output:` æ³¨é‡Š
- ä»£ç è¦å…·æœ‰å®é™…è¿è¡Œä»·å€¼

## 9. æ–‡æ¡£ç¼–å†™è§„èŒƒ

### 9.1 Go Doc è§„èŒƒ
```go
// Package processor æä¾›äº†å¤„ç†å•å…ƒçš„æ³¨å†Œã€ç®¡ç†å’Œè·¯ç”±åŠŸèƒ½ã€‚
// è¯¥åŒ…æ˜¯ Vivid å¼•æ“çš„æ ¸å¿ƒç»„ä»¶ä¹‹ä¸€ï¼Œè´Ÿè´£å¤„ç†å•å…ƒçš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚
package processor

// Registry å®šä¹‰äº†å¤„ç†å•å…ƒæ³¨å†Œè¡¨çš„æ¥å£ã€‚
// æ³¨å†Œè¡¨è´Ÿè´£ç®¡ç†æ‰€æœ‰å¤„ç†å•å…ƒçš„ç”Ÿå‘½å‘¨æœŸï¼ŒåŒ…æ‹¬æ³¨å†Œã€æŸ¥æ‰¾ã€æ³¨é”€ç­‰æ“ä½œã€‚
// æ”¯æŒæœ¬åœ°å’Œè¿œç¨‹å¤„ç†å•å…ƒçš„ç»Ÿä¸€ç®¡ç†ã€‚
type Registry interface {
    // RegisterUnit æ³¨å†Œå¤„ç†å•å…ƒåˆ°æ³¨å†Œè¡¨ã€‚
    // å¦‚æœå•å…ƒå®ç°äº† UnitInitializer æ¥å£ï¼Œä¼šè‡ªåŠ¨è°ƒç”¨åˆå§‹åŒ–æ–¹æ³•ã€‚
    // 
    // å‚æ•°ï¼š
    //   id - å•å…ƒæ ‡è¯†ç¬¦ï¼Œä¸èƒ½ä¸º nil
    //   unit - å¤„ç†å•å…ƒå®ä¾‹ï¼Œä¸èƒ½ä¸º nil
    // 
    // è¿”å›ï¼š
    //   å¦‚æœæ³¨å†ŒæˆåŠŸè¿”å› nilï¼Œå¦åˆ™è¿”å›å…·ä½“é”™è¯¯
    RegisterUnit(id UnitIdentifier, unit Unit) error
}
```

**å¼ºåˆ¶è§„åˆ™**ï¼š
- åŒ…æ³¨é‡Šè¯´æ˜åŒ…çš„ç”¨é€”å’Œæ ¸å¿ƒåŠŸèƒ½
- æ¥å£æ³¨é‡Šè¯´æ˜èŒè´£å’Œä½¿ç”¨åœºæ™¯
- æ–¹æ³•æ³¨é‡ŠåŒ…å«å‚æ•°è¯´æ˜å’Œè¿”å›å€¼è¯´æ˜
- ä½¿ç”¨ä¸“ä¸šæœ¯è¯­ï¼Œä¿æŒé£æ ¼ä¸€è‡´

### 9.2 README è§„èŒƒ
```markdown
# ç»„ä»¶å

ç®€è¦æè¿°ç»„ä»¶åŠŸèƒ½å’Œç”¨é€”ã€‚

## ç‰¹æ€§

- ğŸš€ **é«˜æ€§èƒ½**ï¼šå…·ä½“æ€§èƒ½ç‰¹ç‚¹
- ğŸ”’ **å¹¶å‘å®‰å…¨**ï¼šå¹¶å‘å®‰å…¨ä¿è¯
- ğŸ¯ **çµæ´»é…ç½®**ï¼šé…ç½®èƒ½åŠ›è¯´æ˜

## å¿«é€Ÿå¼€å§‹

### åŸºç¡€ç”¨æ³•

```go
// å®Œæ•´çš„ä½¿ç”¨ç¤ºä¾‹
```

## API æ–‡æ¡£

### ä¸»è¦æ¥å£

| æ–¹æ³• | æè¿° |
|------|------|
| `Method()` | æ–¹æ³•è¯´æ˜ |
```

**å¼ºåˆ¶è§„åˆ™**ï¼š
- å¿…é¡»åŒ…å«åŠŸèƒ½ç‰¹æ€§è¯´æ˜
- å¿…é¡»åŒ…å«å®Œæ•´çš„ä½¿ç”¨ç¤ºä¾‹
- å¿…é¡»åŒ…å« API æ–‡æ¡£è¡¨æ ¼
- ä»£ç ç¤ºä¾‹å¿…é¡»å¯ç›´æ¥è¿è¡Œ

## 10. ç‰ˆæœ¬å…¼å®¹æ€§è§„èŒƒ

### 10.1 API æ¼”è¿›è§„èŒƒ
```go
// æ­£ç¡®ï¼šé€šè¿‡æ¥å£æ‰©å±•å¢åŠ åŠŸèƒ½
type UnitV2 interface {
    Unit
    GetMetrics() Metrics
}

// é”™è¯¯ï¼šä¿®æ”¹ç°æœ‰æ¥å£
type Unit interface {
    Handle(sender UnitIdentifier, message any)
    GetMetrics() Metrics  // ç ´åå…¼å®¹æ€§
}
```

**å¼ºåˆ¶è§„åˆ™**ï¼š
- ä¸ä¿®æ”¹ç°æœ‰æ¥å£å®šä¹‰
- é€šè¿‡æ¥å£ç»„åˆæ‰©å±•åŠŸèƒ½
- æ–°å¢é…ç½®é€‰é¡¹å¿…é¡»å¯é€‰
- åºŸå¼ƒåŠŸèƒ½ä½¿ç”¨ `// Deprecated:` æ ‡è®°

### 10.2 é…ç½®å…¼å®¹æ€§è§„èŒƒ
```go
// æ­£ç¡®ï¼šæ–°å¢å¯é€‰é…ç½®
type Configuration struct {
    Logger    log.Logger     // ç°æœ‰é…ç½®
    NewOption *NewFeature    // æ–°å¢é…ç½®ï¼Œä½¿ç”¨æŒ‡é’ˆè¡¨ç¤ºå¯é€‰
}
```

**å¼ºåˆ¶è§„åˆ™**ï¼š
- æ–°å¢é…ç½®å­—æ®µå¿…é¡»æ˜¯å¯é€‰çš„
- ä½¿ç”¨æŒ‡é’ˆæˆ–æ¥å£è¡¨ç¤ºå¯é€‰é…ç½®
- ä¿æŒé»˜è®¤è¡Œä¸ºä¸å˜
- æä¾›è¿ç§»æŒ‡å—å’Œç¤ºä¾‹

## 11. æ€§èƒ½ä¼˜åŒ–è§„èŒƒ

### 11.1 ç¼“å­˜ç­–ç•¥è§„èŒƒ
```go
// å¼ºåˆ¶ï¼šå¤šçº§ç¼“å­˜æŸ¥æ‰¾é¡ºåº
func (r *registry) GetUnit(id CacheUnitIdentifier) (Unit, error) {
    // 1. æ ‡è¯†ç¬¦ç¼“å­˜
    if unit := id.LoadCache(); unit != nil {
        return unit, nil
    }
    
    // 2. æœ¬åœ°æ³¨å†Œè¡¨
    if unit, loaded := r.units.Load(id.GetPath()); loaded {
        id.StoreCache(unit)  // å›å¡«ç¼“å­˜
        return unit, nil
    }
    
    // 3. è¿œç¨‹è§£æ
    if unit, err := r.fromRPC(id); err == nil {
        return unit, nil
    }
    
    // 4. å®ˆæŠ¤å•å…ƒå›é€€
    return r.getDaemon()
}
```

**å¼ºåˆ¶è§„åˆ™**ï¼š
- å®ç°å¤šçº§ç¼“å­˜ç­–ç•¥æå‡æ€§èƒ½
- ç¼“å­˜å¤±æ•ˆæ—¶è‡ªåŠ¨å›å¡«ç¼“å­˜
- ä½¿ç”¨åŸå­æ“ä½œä¿è¯ç¼“å­˜çº¿ç¨‹å®‰å…¨
- æä¾›ç¼“å­˜æ¸…ç†æœºåˆ¶

### 11.2 æ‰¹å¤„ç†ä¼˜åŒ–è§„èŒƒ
```go
// å¼ºåˆ¶ï¼šåŠ¨æ€æ‰¹å¤„ç†å¤§å°æ§åˆ¶
func (r *rpcUnit) batchPack() bool {
    var batch = processor.NewRPCBatchMessage()
    
    for batch.Len() < r.config.BatchSize {
        if message, ok := r.queue.Pop().(*rpcUnitMessage); ok {
            batch.Add(message...)
        } else {
            break  // é˜Ÿåˆ—ä¸ºç©ºï¼Œç«‹å³å‘é€
        }
    }
    
    if batch.Len() > 0 {
        r.publish(batch)
        return true
    }
    return false
}
```

**å¼ºåˆ¶è§„åˆ™**ï¼š
- åŠ¨æ€è°ƒæ•´æ‰¹å¤„ç†å¤§å°
- é˜Ÿåˆ—ä¸ºç©ºæ—¶ç«‹å³å‘é€é¿å…å»¶è¿Ÿ
- æ‰¹å¤„ç†å¤±è´¥æ—¶å®ç°é‡è¯•æœºåˆ¶
- ç›‘æ§æ‰¹å¤„ç†æ•ˆç‡æŒ‡æ ‡

## 12. æ—¥å¿—å’Œç›‘æ§è§„èŒƒ

### 12.1 æ—¥å¿—è®°å½•è§„èŒƒ
```go
// å¼ºåˆ¶ï¼šç»“æ„åŒ–æ—¥å¿—è®°å½•
func (r *registry) RegisterUnit(id UnitIdentifier, unit Unit) error {
    logger := r.Logger().With(
        "operation", "register_unit",
        "path", id.GetPath(),
        "address", id.GetAddress(),
    )
    
    logger.Info("registering unit")
    
    if err := r.doRegister(id, unit); err != nil {
        logger.Error("failed to register unit", log.Err(err))
        return err
    }
    
    logger.Info("unit registered successfully")
    return nil
}
```

**å¼ºåˆ¶è§„åˆ™**ï¼š
- ä½¿ç”¨ç»“æ„åŒ–æ—¥å¿—è®°å½•å…³é”®æ“ä½œ
- åŒ…å«è¶³å¤Ÿçš„ä¸Šä¸‹æ–‡ä¿¡æ¯ç”¨äºè°ƒè¯•
- åŒºåˆ†ä¸åŒæ—¥å¿—çº§åˆ«ï¼šDebugã€Infoã€Warnã€Error
- é¿å…åœ¨çƒ­è·¯å¾„ä¸­è®°å½•è¿‡å¤šæ—¥å¿—

### 12.2 æŒ‡æ ‡æ”¶é›†è§„èŒƒ
```go
// å¼ºåˆ¶ï¼šå…³é”®æŒ‡æ ‡ç›‘æ§
type registryMetrics struct {
    unitCount     atomic.Int64
    registerCount atomic.Int64
    errorCount    atomic.Int64
}

func (r *registry) RegisterUnit(id UnitIdentifier, unit Unit) error {
    defer func() {
        r.metrics.registerCount.Add(1)
        if r := recover(); r != nil {
            r.metrics.errorCount.Add(1)
            panic(r)
        }
    }()
    
    // æ³¨å†Œé€»è¾‘...
    r.metrics.unitCount.Add(1)
    return nil
}
```

**å¼ºåˆ¶è§„åˆ™**ï¼š
- ç›‘æ§å…³é”®ä¸šåŠ¡æŒ‡æ ‡å’Œæ€§èƒ½æŒ‡æ ‡
- ä½¿ç”¨åŸå­æ“ä½œä¿è¯æŒ‡æ ‡å‡†ç¡®æ€§
- æä¾›æŒ‡æ ‡å¯¼å‡ºæ¥å£ä¾›ç›‘æ§ç³»ç»Ÿä½¿ç”¨
- è®°å½•é”™è¯¯ç‡ã€å»¶è¿Ÿç­‰ SLA æŒ‡æ ‡

---


è¿™å¥—å¼€å‘è§„èŒƒç¡®ä¿äº†ä»£ç çš„ä¸€è‡´æ€§ã€å¯ç»´æŠ¤æ€§å’Œå¯æ‰©å±•æ€§ï¼Œæ˜¯ Engine V1 é¡¹ç›®çš„æ ¸å¿ƒå¼€å‘å‡†åˆ™ã€‚æ‰€æœ‰å¼€å‘è€…éƒ½åº”ä¸¥æ ¼éµå¾ªè¿™äº›è§„èŒƒï¼Œä»¥ä¿è¯é¡¹ç›®çš„é«˜è´¨é‡å’Œé•¿æœŸå¯ç»´æŠ¤æ€§ã€‚ 
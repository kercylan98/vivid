name: Create Release

on:
  push:
    tags:
      - 'v*'  # ÂåπÈÖçÊâÄÊúâ‰ª• v ÂºÄÂ§¥ÁöÑ tagÔºåÂ¶Ç v1.0.0

jobs:
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Ëé∑ÂèñÊâÄÊúâÂéÜÂè≤ËÆ∞ÂΩï‰ª•ÁîüÊàê changelog
      
      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Get tag information
        id: tag_info
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          
          # Ëé∑ÂèñÊâÄÊúâ tags Âπ∂ÊéíÂ∫è
          git fetch --tags
          
          # Ëé∑Âèñ‰∏ä‰∏Ä‰∏™ tagÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
          # ÂÖàÂ∞ùËØïËé∑ÂèñÂΩìÂâç tag ‰πãÂâçÁöÑÊúÄÊñ∞ tag
          PREVIOUS_TAG=$(git tag --sort=-version:refname | grep -A1 "^${TAG_NAME}$" | tail -1 || echo "")
          
          # Â¶ÇÊûúÊ≤°ÊâæÂà∞ÔºåÂ∞ùËØï‰ΩøÁî® git describe
          if [ -z "$PREVIOUS_TAG" ]; then
            PREVIOUS_TAG=$(git describe --tags --abbrev=0 ${TAG_NAME}^ 2>/dev/null || echo "")
          fi
          
          # Â¶ÇÊûúËøòÊòØÊ≤°ÊúâÔºå‰ªéÁ¨¨‰∏Ä‰∏™ commit ÂºÄÂßã
          if [ -z "$PREVIOUS_TAG" ]; then
            PREVIOUS_TAG=$(git rev-list --max-parents=0 HEAD 2>/dev/null || echo "")
          fi
          
          echo "previous_tag=$PREVIOUS_TAG" >> $GITHUB_OUTPUT
          echo "Current tag: $TAG_NAME"
          echo "Previous tag: $PREVIOUS_TAG"
      
      - name: Generate changelog
        id: changelog
        run: |
          TAG_NAME="${{ steps.tag_info.outputs.tag_name }}"
          PREVIOUS_TAG="${{ steps.tag_info.outputs.previous_tag }}"
          
          # ÁîüÊàêÂàÜÁ±ªÁöÑ changelog
          echo "## ÂèòÊõ¥Êó•Âøó" > CHANGELOG.md
          echo "" >> CHANGELOG.md
          
          # Ëé∑ÂèñÊâÄÊúâ commits
          COMMITS=$(git log ${PREVIOUS_TAG}..HEAD --pretty=format:"%s|%h|%an" --reverse)
          
          # ÂàùÂßãÂåñÂàÜÁ±ªÊï∞ÁªÑ
          FEATURES=""
          FIXES=""
          DOCS=""
          REFACTORS=""
          TESTS=""
          CHORES=""
          PERFS=""
          STYLES=""
          OTHERS=""
          
          # Ëß£ÊûêÊØè‰∏™ commit
          while IFS= read -r line; do
            if [ -z "$line" ]; then
              continue
            fi
            
            # ÊèêÂèñ commit Ê∂àÊÅØ„ÄÅhash Âíå‰ΩúËÄÖ
            MSG=$(echo "$line" | cut -d'|' -f1)
            HASH=$(echo "$line" | cut -d'|' -f2)
            AUTHOR=$(echo "$line" | cut -d'|' -f3)
            
            # ÁßªÈô§Á±ªÂûãÂâçÁºÄÂíåÂÜíÂè∑ÔºåÊèêÂèñÊèèËø∞
            if echo "$MSG" | grep -qE "^(feat|fix|docs|refactor|test|chore|perf|style)(\(.+\))?:"; then
              DESC=$(echo "$MSG" | sed -E 's/^(feat|fix|docs|refactor|test|chore|perf|style)(\(.+\))?: //')
            else
              DESC="$MSG"
            fi
            
            # Ê†πÊçÆÁ±ªÂûãÂàÜÁ±ª
            if echo "$MSG" | grep -qE "^feat(\(.+\))?:"; then
              FEATURES="${FEATURES}- ${DESC} ([${HASH:0:7}](https://github.com/${{ github.repository }}/commit/${HASH}))"$'\n'
            elif echo "$MSG" | grep -qE "^fix(\(.+\))?:"; then
              FIXES="${FIXES}- ${DESC} ([${HASH:0:7}](https://github.com/${{ github.repository }}/commit/${HASH}))"$'\n'
            elif echo "$MSG" | grep -qE "^docs(\(.+\))?:"; then
              DOCS="${DOCS}- ${DESC} ([${HASH:0:7}](https://github.com/${{ github.repository }}/commit/${HASH}))"$'\n'
            elif echo "$MSG" | grep -qE "^refactor(\(.+\))?:"; then
              REFACTORS="${REFACTORS}- ${DESC} ([${HASH:0:7}](https://github.com/${{ github.repository }}/commit/${HASH}))"$'\n'
            elif echo "$MSG" | grep -qE "^test(\(.+\))?:"; then
              TESTS="${TESTS}- ${DESC} ([${HASH:0:7}](https://github.com/${{ github.repository }}/commit/${HASH}))"$'\n'
            elif echo "$MSG" | grep -qE "^chore(\(.+\))?:"; then
              CHORES="${CHORES}- ${DESC} ([${HASH:0:7}](https://github.com/${{ github.repository }}/commit/${HASH}))"$'\n'
            elif echo "$MSG" | grep -qE "^perf(\(.+\))?:"; then
              PERFS="${PERFS}- ${DESC} ([${HASH:0:7}](https://github.com/${{ github.repository }}/commit/${HASH}))"$'\n'
            elif echo "$MSG" | grep -qE "^style(\(.+\))?:"; then
              STYLES="${STYLES}- ${DESC} ([${HASH:0:7}](https://github.com/${{ github.repository }}/commit/${HASH}))"$'\n'
            else
              OTHERS="${OTHERS}- ${MSG} ([${HASH:0:7}](https://github.com/${{ github.repository }}/commit/${HASH}))"$'\n'
            fi
          done <<< "$COMMITS"
          
          # ÂÜôÂÖ•ÂàÜÁ±ªÂÜÖÂÆπ
          if [ -n "$FEATURES" ]; then
            echo "### ‚ú® Êñ∞ÂäüËÉΩ (Features)" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo -n "$FEATURES" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
          fi
          
          if [ -n "$FIXES" ]; then
            echo "### üêõ ÈóÆÈ¢ò‰øÆÂ§ç (Bug Fixes)" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo -n "$FIXES" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
          fi
          
          if [ -n "$DOCS" ]; then
            echo "### üìù ÊñáÊ°£Êõ¥Êñ∞ (Documentation)" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo -n "$DOCS" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
          fi
          
          if [ -n "$REFACTORS" ]; then
            echo "### ‚ôªÔ∏è ‰ª£Á†ÅÈáçÊûÑ (Refactoring)" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo -n "$REFACTORS" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
          fi
          
          if [ -n "$PERFS" ]; then
            echo "### ‚ö° ÊÄßËÉΩ‰ºòÂåñ (Performance)" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo -n "$PERFS" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
          fi
          
          if [ -n "$TESTS" ]; then
            echo "### ‚úÖ ÊµãËØïÁõ∏ÂÖ≥ (Tests)" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo -n "$TESTS" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
          fi
          
          if [ -n "$CHORES" ]; then
            echo "### üîß ÊûÑÂª∫/Â∑•ÂÖ∑Áõ∏ÂÖ≥ (Chores)" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo -n "$CHORES" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
          fi
          
          if [ -n "$STYLES" ]; then
            echo "### üíÑ Ê†∑ÂºèË∞ÉÊï¥ (Style)" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo -n "$STYLES" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
          fi
          
          if [ -n "$OTHERS" ]; then
            echo "### üì¶ ÂÖ∂‰ªñÂèòÊõ¥" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo -n "$OTHERS" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
          fi
          
          # Â¶ÇÊûúÊ≤°ÊúâÂèòÊõ¥ÔºåÊ∑ªÂä†ÊèêÁ§∫
          if [ -z "$FEATURES$FIXES$DOCS$REFACTORS$PERFS$TESTS$CHORES$STYLES$OTHERS" ]; then
            echo "### üìã ÂèòÊõ¥ËÆ∞ÂΩï" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo "Ê≠§ÁâàÊú¨Ê≤°ÊúâÁ¨¶Âêà Conventional Commits ËßÑËåÉÁöÑÊèê‰∫§ËÆ∞ÂΩï„ÄÇ" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
          fi
          
          echo "---" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "### üìä ÁªüËÆ°‰ø°ÊÅØ" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "**ÁâàÊú¨**: \`${TAG_NAME}\`" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "**Êèê‰∫§ËåÉÂõ¥**: \`${PREVIOUS_TAG}\` ‚Üí \`${TAG_NAME}\`" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          TOTAL_COMMITS=$(git rev-list --count ${PREVIOUS_TAG}..HEAD)
          echo "**ÊÄªÊèê‰∫§Êï∞**: ${TOTAL_COMMITS}" >> CHANGELOG.md
      
      - name: Display changelog
        run: |
          echo "Generated changelog:"
          cat CHANGELOG.md
      
      - name: Create Draft Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag_info.outputs.tag_name }}
          name: Release ${{ steps.tag_info.outputs.tag_name }}
          body_path: CHANGELOG.md
          draft: true
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

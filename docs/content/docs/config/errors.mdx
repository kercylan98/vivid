---
title: 错误处理
description: vivid 错误体系、预定义错误码、errors.Is/As 与错误链
---

Vivid 使用 **`*vivid.Error`** 表示可序列化、支持错误码与错误链的异常，可与标准库 **errors.Is** / **errors.As** 配合判定。本文说明错误类型用法与预定义错误码分类；监督与故障上报见 [监督策略](/docs/config/supervision)、[创建与生命周期 - Failed](/docs/basics/lifecycle#主动上报故障failed)。

## Error 类型与用法

**`*vivid.Error`** 可在分布式环境中序列化传播，支持错误链与 **errors.Is** / **errors.As** 递归判定：

| 方法 / 行为 | 说明 |
|-------------|------|
| **GetCode() int32** | 错误码，用于日志、监控或跨节点一致判定 |
| **GetMessage() string** | 可读描述（不含前缀与错误码） |
| **With(err error) \*Error** | 包装底层错误，**Unwrap** 返回 err，便于错误链判定 |
| **WithMessage(msg string) \*Error** | 在描述后追加说明，不改变错误码 |
| **Error() string** | 实现 `error` 接口，格式为 `[vivid: <code>] <msg>` |

判定示例：

```go
if errors.Is(err, vivid.ErrorActorAlreadyExists) {
    // 同父下名称重复
}
if errors.Is(err, vivid.ErrorFutureTimeout) {
    // Ask 超时
}
var vividErr *vivid.Error
if errors.As(err, &vividErr) {
    code := vividErr.GetCode()
}
```

## 预定义错误码

预定义错误按**功能领域**分组，错误码区间与代码中 `RegisterError` 的划分一致，便于查找与扩展。

### 运行时错误

ActorSystem 生命周期、重复启停及通用资源不存在等。

| 变量 | 说明 |
|------|------|
| **ErrorException** | 未分类内部异常 |
| **ErrorNotFound** | 资源不存在（如调度器 **Cancel** 时指定 reference 不存在） |
| **ErrorActorSystemAlreadyStarted** | 重复调用 Start |
| **ErrorActorSystemAlreadyStopped** | 重复调用 Stop |
| **ErrorActorSystemStartFailed** | 系统启动失败 |
| **ErrorActorSystemStopFailed** | 系统停止失败 |
| **ErrorActorSystemNotStarted** | 未启动时调用 Stop |

### Actor 与生命周期

Actor 创建、预启动及存活状态相关。

| 变量 | 说明 |
|------|------|
| **ErrorActorDeaded** | Actor 已死亡（如在已死亡父级上创建） |
| **ErrorActorAlreadyExists** | 同父下名称重复 |
| **ErrorActorSpawnFailed** | Actor 创建失败 |
| **ErrorActorPrelaunchFailed** | 预启动（Prelaunch）失败 |

### Future 与消息传输

Ask/Result、Future 生命周期及消息长度与缓冲读取。

| 变量 | 说明 |
|------|------|
| **ErrorFutureTimeout** | Result/Wait 超时未收到应答 |
| **ErrorFutureMessageTypeMismatch** | 应答类型与泛型声明不一致 |
| **ErrorFutureUnexpectedError** | 收到非预期错误 |
| **ErrorFutureInvalid** | 创建 Future 时参数非法（如 timeout） |
| **ErrorInvalidMessageLength** | 消息长度非法（如 Remoting 协议层） |
| **ErrorReadMessageBufferFailed** | 读消息缓冲失败 |

### 参数与调度

调用参数不合法及调度器（如 Cron）解析失败。

| 变量 | 说明 |
|------|------|
| **ErrorIllegalArgument** | 参数无效或缺失 |
| **ErrorCronParse** | Cron 表达式解析失败 |

### ActorRef

ActorRef 解析、格式及 Agent 引用。

| 变量 | 说明 |
|------|------|
| **ErrorRefEmpty** | ActorRef 为空 |
| **ErrorRefFormat** | ActorRef 格式错误（须包含 address 与 path） |
| **ErrorRefInvalidAddress** | 地址非法 |
| **ErrorRefInvalidPath** | 路径非法 |
| **ErrorRefNilAgent** | AgentRef 为 nil |

### 远程通信

跨节点消息发送、编解码与处理。

| 变量 | 说明 |
|------|------|
| **ErrorRemotingMessageSendFailed** | 远程消息发送失败 |
| **ErrorRemotingMessageEncodeFailed** | 远程消息编码失败 |
| **ErrorRemotingMessageDecodeFailed** | 远程消息解码失败 |
| **ErrorRemotingMessageHandleFailed** | 远程消息处理失败 |

### 集群

集群名称校验及未启用时的调用。

| 变量 | 说明 |
|------|------|
| **ErrorClusterNameMismatch** | 集群名称不匹配 |
| **ErrorClusterDisabled** | 集群已禁用（未启用集群时调用 ClusterContext 的 GetMembers/Leader/IsLeader/InQuorum 等会返回此错误） |

---

完整列表与错误码见 [pkg.go.dev - vivid](https://pkg.go.dev/github.com/kercylan98/vivid#pkg-variables)。**RegisterError** 用于在包 init 或启动阶段注册自定义错误码，供跨节点一致识别。
